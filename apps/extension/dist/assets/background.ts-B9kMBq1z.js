console.log("[FG] SW loaded (top-level)");chrome.runtime.onInstalled.addListener(t=>{console.log("[FG] onInstalled:",t.reason)});chrome.runtime.onStartup.addListener(()=>{console.log("[FG] onStartup")});const c=Object.create(null),f=3e4;function d(){const t=Date.now();for(const[a,r]of Object.entries(c))(!r||t-r.ts>f)&&delete c[a]}function y(t){const a=`${Date.now()}-${Math.random().toString(36).slice(2,8)}`;return c[a]={dataUrl:t,ts:Date.now()},d(),a}const u="fg_session_end";function h(t){try{chrome.alarms.create(u,{when:t}),console.log("[FG] alarm scheduled:",new Date(t).toISOString())}catch(a){console.warn("[FG] failed to schedule alarm:",a)}}function E(){chrome.alarms.clear(u,t=>{console.log("[FG] alarm cleared:",t)})}function S(t){chrome.tabs.query({},a=>{for(const r of a)if(r.id!=null)try{chrome.tabs.sendMessage(r.id,t)}catch{}})}chrome.alarms.onAlarm.addListener(t=>{t.name===u&&(console.log("[FG] session end alarm fired"),S({type:"FG_SESSION_FINISHED"}))});chrome.runtime.onMessage.addListener((t,a,r)=>{try{if(t?.type==="PING"){r({ok:!0});return}if(t?.type==="CAPTURE_FOR_CHECK")return chrome.tabs.captureVisibleTab({format:"png"},e=>{if(chrome.runtime.lastError||!e){r({ok:!1,error:chrome.runtime.lastError?.message||"no image"});return}const o=y(e);r({ok:!0,key:o})}),!0;if(t?.type==="GET_CAPTURE_BY_KEY"){const e=String(t.key??""),o=c[e];o&&Date.now()-o.ts<=f?r({ok:!0,dataUrl:o.dataUrl}):r({ok:!1,error:"expired_or_not_found"});return}if(t?.type==="FG_FORCE_CHECK"){const e=a.tab?.id;if(typeof e=="number"){chrome.tabs.sendMessage(e,{type:"FG_FORCE_CHECK"}),r({ok:!0,target:e});return}return chrome.tabs.query({active:!0,currentWindow:!0},o=>{const n=o[0]?.id??null;typeof n=="number"&&chrome.tabs.sendMessage(n,{type:"FG_FORCE_CHECK"}),r({ok:!0,target:n})}),!0}if(t?.type==="FG_FETCH_JSON")return(async()=>{try{const e=t.url,o=(t.method||"POST").toUpperCase(),n=t.body;if(typeof e!="string"||!e){r({ok:!1,status:0,error:"bad_url"});return}if(o!=="POST"&&o!=="PUT"&&o!=="PATCH"&&o!=="DELETE"&&o!=="GET"){r({ok:!1,status:0,error:"bad_method"});return}const s={method:o,headers:{"content-type":"application/json"}};o!=="GET"&&n!==void 0&&(s.body=typeof n=="string"?n:JSON.stringify(n));const i=await fetch(e,s);let l=null;try{l=await i.json()}catch{l=null}r({ok:i.ok,status:i.status,data:l})}catch(e){r({ok:!1,status:0,error:String(e)})}})(),!0;if(t?.type==="FG_SCHEDULE_SESSION_END"&&typeof t.endAt=="number"){h(t.endAt),r({ok:!0});return}if(t?.type==="FG_CANCEL_SESSION_END"){E(),r({ok:!0});return}return}catch(e){console.warn("[FG] SW onMessage error:",e);try{r({ok:!1,error:String(e)})}catch{}return}});
//# sourceMappingURL=background.ts-B9kMBq1z.js.map
