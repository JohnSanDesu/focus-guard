{"version":3,"file":"background.ts-B9kMBq1z.js","sources":["../../src/background.ts"],"sourcesContent":["/// <reference types=\"chrome\" />\r\n\r\n// FocusGuard Service Worker (MV3)\r\n// - TTL cache for screenshot data URLs\r\n// - Session end alarm\r\n// - Message router (PING / CAPTURE / GET / FG_* control / proxy fetch)\r\n\r\nconsole.log(\"[FG] SW loaded (top-level)\");\r\n\r\n// ---- lifecycle logs (optional) ----\r\nchrome.runtime.onInstalled.addListener((info) => {\r\n  console.log(\"[FG] onInstalled:\", info.reason);\r\n});\r\nchrome.runtime.onStartup.addListener(() => {\r\n  console.log(\"[FG] onStartup\");\r\n});\r\n\r\n// ---- TTL cache for captured screenshots ----\r\ntype CacheRec = { dataUrl: string; ts: number };\r\nconst cache: Record<string, CacheRec | undefined> = Object.create(null);\r\nconst TTL_MS = 30_000;\r\n\r\nfunction purge() {\r\n  const now = Date.now();\r\n  for (const [k, rec] of Object.entries(cache)) {\r\n    if (!rec || now - rec.ts > TTL_MS) delete cache[k];\r\n  }\r\n}\r\n\r\nfunction saveCapture(dataUrl: string): string {\r\n  const key = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;\r\n  cache[key] = { dataUrl, ts: Date.now() };\r\n  purge();\r\n  return key;\r\n}\r\n\r\n// ---- session end alarm ----\r\nconst SESSION_ALARM = \"fg_session_end\";\r\nconst ENABLE_SYSTEM_NOTIFICATION = false;\r\n\r\nfunction scheduleSessionEnd(endAt: number) {\r\n  try {\r\n    chrome.alarms.create(SESSION_ALARM, { when: endAt });\r\n    console.log(\"[FG] alarm scheduled:\", new Date(endAt).toISOString());\r\n  } catch (e) {\r\n    console.warn(\"[FG] failed to schedule alarm:\", e);\r\n  }\r\n}\r\n\r\nfunction cancelSessionEnd() {\r\n  chrome.alarms.clear(SESSION_ALARM, (ok) => {\r\n    console.log(\"[FG] alarm cleared:\", ok);\r\n  });\r\n}\r\n\r\nfunction broadcastToAllTabs(message: any) {\r\n  chrome.tabs.query({}, (tabs) => {\r\n    for (const t of tabs) {\r\n      if (t.id != null) {\r\n        try {\r\n          chrome.tabs.sendMessage(t.id, message);\r\n        } catch {}\r\n      }\r\n    }\r\n  });\r\n}\r\n\r\nchrome.alarms.onAlarm.addListener((alarm) => {\r\n  if (alarm.name !== SESSION_ALARM) return;\r\n\r\n  console.log(\"[FG] session end alarm fired\");\r\n\r\n  broadcastToAllTabs({ type: \"FG_SESSION_FINISHED\" });\r\n  if (ENABLE_SYSTEM_NOTIFICATION) {\r\n    try {\r\n      chrome.notifications.create({\r\n        type: \"basic\",\r\n        iconUrl: \"icon128.png\",\r\n        title: \"FocusGuard\",\r\n        message: \"Session finished.\",\r\n        priority: 2,\r\n      });\r\n    } catch (e) {\r\n      console.warn(\"[FG] notifications create failed:\", e);\r\n    }\r\n  }\r\n});\r\n\r\n// ---- message router ----\r\nchrome.runtime.onMessage.addListener((msg: any, sender, sendResponse) => {\r\n  try {\r\n    // 0) health\r\n    if (msg?.type === \"PING\") {\r\n      sendResponse({ ok: true });\r\n      return; // sync response\r\n    }\r\n\r\n    // 1) capture → save in TTL cache (do not return data URL directly)\r\n    if (msg?.type === \"CAPTURE_FOR_CHECK\") {\r\n      chrome.tabs.captureVisibleTab({ format: \"png\" }, (dataUrl) => {\r\n        if (chrome.runtime.lastError || !dataUrl) {\r\n          sendResponse({\r\n            ok: false,\r\n            error: chrome.runtime.lastError?.message || \"no image\",\r\n          });\r\n          return;\r\n        }\r\n        const key = saveCapture(dataUrl);\r\n        sendResponse({ ok: true, key });\r\n      });\r\n      return true; // async response\r\n    }\r\n\r\n    // 2) get capture by key\r\n    if (msg?.type === \"GET_CAPTURE_BY_KEY\") {\r\n      const key = String(msg.key ?? \"\");\r\n      const rec = cache[key];\r\n      if (rec && Date.now() - rec.ts <= TTL_MS) {\r\n        sendResponse({ ok: true, dataUrl: rec.dataUrl });\r\n      } else {\r\n        sendResponse({ ok: false, error: \"expired_or_not_found\" });\r\n      }\r\n      return; // sync response\r\n    }\r\n\r\n    // 3) force a check in the sender tab or active tab\r\n    if (msg?.type === \"FG_FORCE_CHECK\") {\r\n      const fromTabId = sender.tab?.id;\r\n      if (typeof fromTabId === \"number\") {\r\n        chrome.tabs.sendMessage(fromTabId, { type: \"FG_FORCE_CHECK\" });\r\n        sendResponse({ ok: true, target: fromTabId });\r\n        return; // sync response\r\n      }\r\n      chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {\r\n        const id = tabs[0]?.id ?? null;\r\n        if (typeof id === \"number\") {\r\n          chrome.tabs.sendMessage(id, { type: \"FG_FORCE_CHECK\" });\r\n        }\r\n        sendResponse({ ok: true, target: id });\r\n      });\r\n      return true; // async response\r\n    }\r\n\r\n    // 4) proxy fetch for JSON (bypass HTTPS→HTTP mixed-content restrictions)\r\n    //    usage from content.ts: sendMessage({ type:\"FG_FETCH_JSON\", url, body, method? })\r\n    if (msg?.type === \"FG_FETCH_JSON\") {\r\n      (async () => {\r\n        try {\r\n          const url: string = msg.url;\r\n          const method: string = (msg.method || \"POST\").toUpperCase();\r\n          const body = msg.body;\r\n\r\n          if (typeof url !== \"string\" || !url) {\r\n            sendResponse({ ok: false, status: 0, error: \"bad_url\" });\r\n            return;\r\n          }\r\n          if (method !== \"POST\" && method !== \"PUT\" && method !== \"PATCH\" && method !== \"DELETE\" && method !== \"GET\") {\r\n            sendResponse({ ok: false, status: 0, error: \"bad_method\" });\r\n            return;\r\n          }\r\n\r\n          const init: RequestInit = {\r\n            method,\r\n            headers: { \"content-type\": \"application/json\" },\r\n          };\r\n          if (method !== \"GET\" && body !== undefined) {\r\n            init.body = typeof body === \"string\" ? body : JSON.stringify(body);\r\n          }\r\n\r\n          const r = await fetch(url, init);\r\n          let data: any = null;\r\n          try {\r\n            data = await r.json();\r\n          } catch {\r\n            // not JSON or empty body; return null\r\n            data = null;\r\n          }\r\n          sendResponse({ ok: r.ok, status: r.status, data });\r\n        } catch (e) {\r\n          sendResponse({ ok: false, status: 0, error: String(e) });\r\n        }\r\n      })();\r\n      return true; // async response\r\n    }\r\n\r\n    // 5) schedule/cancel session end alarm\r\n    if (msg?.type === \"FG_SCHEDULE_SESSION_END\" && typeof msg.endAt === \"number\") {\r\n      scheduleSessionEnd(msg.endAt);\r\n      sendResponse({ ok: true });\r\n      return; // sync response\r\n    }\r\n    if (msg?.type === \"FG_CANCEL_SESSION_END\") {\r\n      cancelSessionEnd();\r\n      sendResponse({ ok: true });\r\n      return; // sync response\r\n    }\r\n\r\n    // unknown message → no-op\r\n    return;\r\n  } catch (e) {\r\n    console.warn(\"[FG] SW onMessage error:\", e);\r\n    try {\r\n      sendResponse({ ok: false, error: String(e) });\r\n    } catch {}\r\n    return; // best-effort\r\n  }\r\n});\r\n"],"names":["info","cache","TTL_MS","purge","now","k","rec","saveCapture","dataUrl","key","SESSION_ALARM","scheduleSessionEnd","endAt","e","cancelSessionEnd","ok","broadcastToAllTabs","message","tabs","t","alarm","msg","sender","sendResponse","fromTabId","id","url","method","body","init","r","data"],"mappings":"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"}