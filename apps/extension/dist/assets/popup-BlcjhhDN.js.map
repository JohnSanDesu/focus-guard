{"version":3,"file":"popup-BlcjhhDN.js","sources":["../../src/ui/start.ts"],"sourcesContent":["/// <reference types=\"chrome\" />\r\n\r\ntype FocusProfile = { allow: string[]; block: string[] }; // neutral removed\r\n\r\nconst BASE_CATEGORIES = [\r\n  \"Mathematics\",\"Computer Science\",\"Data Science\",\"Software Engineering\",\"Research Methods\",\r\n  \"Finance Study\",\"Economics\",\"Health Study\",\"Physics\",\"Chemistry\",\r\n  \"Biology\",\"Language Learning\",\"Productivity\",\"General News\",\"Tech News\",\r\n  \"Gaming\",\"Variety Entertainment\",\"Short-form Social\",\"Sports\",\"Music\"\r\n];\r\n\r\nfunction fillSelect(el: HTMLSelectElement, items: string[]) {\r\n  el.innerHTML = \"\";\r\n  for (const v of items) {\r\n    const opt = document.createElement(\"option\");\r\n    opt.value = v; opt.textContent = v;\r\n    el.appendChild(opt);\r\n  }\r\n}\r\n\r\nfunction getSelected(el: HTMLSelectElement): string[] {\r\n  return Array.from(el.selectedOptions).map(o => o.value);\r\n}\r\n\r\nfunction uniq<T>(xs: T[]) { return Array.from(new Set(xs)); }\r\n\r\nfunction normalizeProfile(allow: string[], block: string[]): FocusProfile {\r\n  const b = uniq(block);\r\n  const a = uniq(allow.filter(x => !b.includes(x))); // block wins\r\n  return { allow: a, block: b };\r\n}\r\n\r\ntype Existing = { minutes?: number; consent?: boolean; profile?: FocusProfile; goal?: string };\r\n\r\nasync function loadExisting(): Promise<Existing> {\r\n  return new Promise(resolve => {\r\n    chrome.storage.local.get([\"fg_minutes\", \"fg_consent\", \"fg_profile\", \"fg_goal\"], (d) => {\r\n      const out: Existing = {};\r\n\r\n      if (typeof d?.fg_minutes === \"number\") out.minutes = d.fg_minutes;\r\n      if (typeof d?.fg_consent === \"boolean\") out.consent = d.fg_consent;\r\n\r\n      const p = d?.fg_profile as any;\r\n      if (p && Array.isArray(p.allow) && Array.isArray(p.block)) {\r\n        out.profile = { allow: p.allow, block: p.block };\r\n      }\r\n\r\n      if (typeof d?.fg_goal === \"string\") out.goal = d.fg_goal;\r\n\r\n      resolve(out);\r\n    });\r\n  });\r\n}\r\n\r\nasync function getActiveEnd(): Promise<number | null> {\r\n  return new Promise(res => {\r\n    chrome.storage.local.get([\"fg_session_endAt\"], (d) => {\r\n      const t = d?.fg_session_endAt;\r\n      res(typeof t === \"number\" && t > Date.now() ? t : null);\r\n    });\r\n  });\r\n}\r\n\r\nfunction fmt(remMs: number) {\r\n  const s = Math.max(0, Math.floor(remMs / 1000));\r\n  const mm = String(Math.floor(s / 60)).padStart(2, \"0\");\r\n  const ss = String(s % 60).padStart(2, \"0\");\r\n  return `${mm}:${ss}`;\r\n}\r\n\r\nasync function main() {\r\n  const elStatus = document.getElementById(\"fg-status\")!;\r\n  const elMinutes = document.querySelector<HTMLInputElement>(\"#fg-minutes\")!;\r\n  const elConsent = document.querySelector<HTMLInputElement>(\"#fg-consent\")!;\r\n  const elAllow   = document.querySelector<HTMLSelectElement>(\"#fg-allow\")!;\r\n  const elBlock   = document.querySelector<HTMLSelectElement>(\"#fg-block\")!;\r\n  const elNeutral = document.querySelector<HTMLSelectElement>(\"#fg-neutral\")!;\r\n  const elGoal    = document.querySelector<HTMLTextAreaElement>(\"#fg-goal\")!;\r\n  const elSave    = document.querySelector<HTMLButtonElement>(\"#fg-save\")!;\r\n  const elClear   = document.querySelector<HTMLButtonElement>(\"#fg-clear\")!;\r\n  const elStop    = document.querySelector<HTMLButtonElement>(\"#fg-stop\")!;\r\n\r\nfunction ensureOption(select: HTMLSelectElement, value: string) {\r\n  const exists = Array.from(select.options).some(o => o.value === value);\r\n  if (!exists) {\r\n    const opt = document.createElement(\"option\");\r\n    opt.value = value; opt.textContent = value;\r\n    select.appendChild(opt);\r\n  }\r\n}\r\n\r\nfunction removeSelected(select: HTMLSelectElement) {\r\n  const keep: HTMLOptionElement[] = [];\r\n  for (const opt of Array.from(select.options)) {\r\n    if (!opt.selected) keep.push(opt);\r\n  }\r\n  select.innerHTML = \"\";\r\n  for (const opt of keep) select.appendChild(opt);\r\n}\r\n\r\nfunction addFromNeutral(target: \"allow\" | \"block\") {\r\n  const src = elNeutral;\r\n  const dst = target === \"allow\" ? elAllow : elBlock;\r\n  const other = target === \"allow\" ? elBlock : elAllow;\r\n\r\n  const selected = Array.from(src.selectedOptions).map(o => o.value);\r\n\r\n  for (const v of selected) {\r\n    const inOther = Array.from(other.options).some(o => o.value === v);\r\n    if (target === \"allow\" && inOther) {\r\n      continue;\r\n    }\r\n    if (target === \"block\") {\r\n      const toRemove = Array.from(elAllow.options).find(o => o.value === v);\r\n      if (toRemove) toRemove.remove();\r\n    }\r\n    ensureOption(dst, v);\r\n  }\r\n}\r\n\r\n// buttons\r\ndocument.getElementById(\"fg-to-allow\")!.addEventListener(\"click\", () => addFromNeutral(\"allow\"));\r\ndocument.getElementById(\"fg-to-block\")!.addEventListener(\"click\", () => addFromNeutral(\"block\"));\r\ndocument.getElementById(\"fg-rm-allow\")!.addEventListener(\"click\", () => removeSelected(elAllow));\r\ndocument.getElementById(\"fg-rm-block\")!.addEventListener(\"click\", () => removeSelected(elBlock));\r\n\r\nelNeutral.addEventListener(\"dblclick\", (ev) => {\r\n  const e = ev as MouseEvent;\r\n  if (e.shiftKey) addFromNeutral(\"block\");\r\n  else addFromNeutral(\"allow\");\r\n});\r\n\r\n  fillSelect(elNeutral, BASE_CATEGORIES);\r\n\r\n  const ex = await loadExisting();\r\n  if (ex?.minutes) elMinutes.value = String(ex.minutes);\r\n  if (typeof ex?.consent === \"boolean\") elConsent.checked = ex.consent;\r\n\r\n  const savedAllow = ex?.profile?.allow ?? [];\r\n  const savedBlock = ex?.profile?.block ?? [];\r\n  fillSelect(elAllow, savedAllow);\r\n  fillSelect(elBlock, savedBlock);\r\n\r\n  let timer: number | undefined;\r\n  async function renderStatus() {\r\n    const endAt = await getActiveEnd();\r\n    if (endAt) {\r\n      const rem = endAt - Date.now();\r\n      elStatus.textContent = `セッション中 — 残り ${fmt(rem)}`;\r\n      elSave.disabled = true;\r\n      elClear.disabled = true;\r\n      elMinutes.disabled = true;\r\n      elConsent.disabled = true;\r\n      elAllow.disabled = true;\r\n      elBlock.disabled = true;\r\n      elGoal.disabled = true;\r\n      elStop.hidden = false;\r\n      if (timer) clearInterval(timer);\r\n      timer = window.setInterval(() => {\r\n        const left = endAt - Date.now();\r\n        if (left <= 0) {\r\n          clearInterval(timer);\r\n          elStatus.textContent = \"セッション終了\";\r\n          elStop.hidden = true;\r\n          elSave.disabled = false;\r\n          elClear.disabled = false;\r\n          elMinutes.disabled = false;\r\n          elConsent.disabled = false;\r\n          elAllow.disabled = false;\r\n          elBlock.disabled = false;\r\n          elGoal.disabled = false;\r\n        } else {\r\n          elStatus.textContent = `セッション中 — 残り ${fmt(left)}`;\r\n        }\r\n      }, 1000);\r\n    } else {\r\n      elStatus.textContent = \"待機中（セッション未開始）\";\r\n      elSave.disabled = false;\r\n      elClear.disabled = false;\r\n      elMinutes.disabled = false;\r\n      elConsent.disabled = false;\r\n      elAllow.disabled = false;\r\n      elBlock.disabled = false;\r\n      elGoal.disabled = false;\r\n      elStop.hidden = true;\r\n      if (timer) clearInterval(timer);\r\n    }\r\n  }\r\n  await renderStatus();\r\n\r\n  elSave.onclick = async () => {\r\n    const active = await getActiveEnd();\r\n    if (active) {\r\n      alert(\"すでにセッション中です。停止してから再度開始してください。\");\r\n      return;\r\n    }\r\n    const minutes = Math.max(1, Math.floor(Number(elMinutes.value) || 30));\r\n    const consent = elConsent.checked;\r\n    const profile = normalizeProfile(getSelected(elAllow), getSelected(elBlock));\r\n    const goal = (elGoal.value || \"\").trim();\r\n    if (!goal) { alert(\"Goal は必須です。\"); return; }\r\n    const endAt = Date.now() + minutes * 60_000;\r\n\r\n    const goalClamped = goal.slice(0, 300);\r\n\r\n    await chrome.storage.local.set({\r\n      fg_minutes: minutes,\r\n      fg_consent: consent,\r\n      fg_profile: profile,\r\n      fg_goal: goalClamped,\r\n      fg_session_endAt: endAt,\r\n    });\r\n\r\n    try { await chrome.runtime.sendMessage({ type: \"FG_FORCE_CHECK\" }); } catch {}\r\n    window.close();\r\n  };\r\n\r\n  elClear.onclick = async () => {\r\n    const active = await getActiveEnd();\r\n    if (active) return;\r\n    elMinutes.value = \"30\";\r\n    elConsent.checked = false;\r\n    fillSelect(elAllow, []);\r\n    fillSelect(elBlock, []);\r\n    elGoal.value = \"\";\r\n  };\r\n\r\n  elStop.onclick = async () => {\r\n    await chrome.storage.local.set({ fg_session_endAt: Date.now() });\r\n    await chrome.storage.local.remove([\"fg_goal\"]);\r\n    await renderStatus();\r\n  };\r\n\r\n  chrome.storage.onChanged.addListener((changes, area) => {\r\n    if (area !== \"local\") return;\r\n    if (\"fg_session_endAt\" in changes) renderStatus();\r\n  });\r\n}\r\n\r\nmain().catch(console.error);\r\n"],"names":["BASE_CATEGORIES","fillSelect","el","items","v","opt","getSelected","o","uniq","xs","normalizeProfile","allow","block","b","x","loadExisting","resolve","d","out","p","getActiveEnd","res","t","fmt","remMs","s","mm","ss","main","elStatus","elMinutes","elConsent","elAllow","elBlock","elNeutral","elGoal","elSave","elClear","elStop","ensureOption","select","value","removeSelected","keep","addFromNeutral","target","src","dst","other","selected","inOther","toRemove","ev","ex","savedAllow","savedBlock","timer","renderStatus","endAt","rem","left","minutes","consent","profile","goal","goalClamped","changes","area"],"mappings":"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"}